services:
  images-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: images-api-service
    ports:
      - "5512:5512"
      - "5513:5513"
    volumes:
      - ./logs:/app/logs
      - ./core:/app/core
      - /home/ecs-user/workspace/google_oauth:/app/google_oauth:ro
    restart: unless-stopped
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=info
      # MinIOé…ç½® - è¿æ¥åˆ°ç°æœ‰çš„jarvis_minioå®¹å™¨
      - MINIO_ENDPOINT=172.22.0.3:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin123
      - MINIO_SECURE=false
      - MINIO_BUCKET_NAME=images
      # Redisé…ç½® - è¿æ¥åˆ°ç°æœ‰çš„jarvis_rediså®¹å™¨
      - REDIS_HOST=jarvis_redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      # æœåŠ¡å™¨é…ç½®
      - SERVER_BASE_URL=http://8.219.206.213:5512
      - HOST=0.0.0.0
      - PORT=5512
      - MCP_PORT=5513
      # æ€§èƒ½é…ç½®
      - WORKERS=4
      - MAX_CONNECTIONS=1000
      - KEEPALIVE_TIMEOUT=30
      # Googleäº‘æœåŠ¡é…ç½®
      - GOOGLE_APPLICATION_CREDENTIALS=/app/google_oauth/qhhl-veo-26fd3f12ace3.json
      - VEO3_PROJECT_ID=qhhl-veo
      - VEO3_LOCATION=us-central1
      - VEO3_STORAGE_BUCKET=veo-output-pub
      - VERTEX_PROJECT_ID=qhhl-veo
      - VERTEX_LOCATION=us-central1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5512/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - jarvis-v2_default
    # ğŸ¯ æ–¹æ¡ˆä¸€ï¼šç®€åŒ–çš„Celery Workerå¯åŠ¨å‘½ä»¤ï¼ˆåŒ…å«MCPæœåŠ¡ï¼‰
    command: >
      sh -c "
        echo 'ğŸš€ å¯åŠ¨ç®€åŒ–çš„å•é˜Ÿåˆ—Celeryæ¶æ„ + MCPæœåŠ¡' &&
        python main.py &
        python scripts/run_mcp_streamable.py &
        sleep 10 &&
        celery -A celery_config worker --loglevel=info --pool=threads --concurrency=4 &
        wait
      "

networks:
  jarvis-v2_default:
    external: true 