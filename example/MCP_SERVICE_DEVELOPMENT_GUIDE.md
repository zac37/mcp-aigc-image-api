
# MCP服务开发经验指南 (MCP Service Development Guide)

- **版本:** v1.0
- **更新日期:** 2025-06-09

## 1. 概述

本指南总结了在`JARVIS-V2`项目中开发`MCP`（Model-Consumable Platform，模型可消费平台）服务的核心经验、架构原则和最佳实践。旨在指导AI或开发人员在未来快速、高效、规范地构建新的MCP服务。

MCP服务的核心定位是作为AI Agent与外部API（如Meta Marketing API）之间的桥梁。它将复杂的、非标准化的外部API封装成稳定、可预测、AI友好的工具（Functions）。

## 2. 核心架构与设计原则

#### **AI驱动原则 (AI-Driven Principle)**
MCP服务是为AI Agent消费而设计的。所有API接口（即工具）的定义必须极其严格和清晰。

- **函数签名即契约**: 工具的函数签名（包括参数、类型提示、Docstrings）是AI唯一能理解的"文档"。必须保证其准确性、完整性，无任何隐式假设。
- **参数明确性**: 避免"可选但实际必需"的参数。如果一个参数在大多数情况下都必须提供，就应在函数签名中标记为必需。例如，`access_token`就应该是一个必需参数。

#### **分层架构 (Layered Architecture)**
严格遵循`路由(Routers) -> 服务(Services) -> 客户端(Clients)`的分层模式。

- `meta-curl-api/routers/`: 只负责处理HTTP请求、解析参数、调用服务层并返回响应。**严禁包含任何业务逻辑**。
- `meta-curl-api/services/`: 负责实现核心业务逻辑。它调用下游客户端，处理数据，执行操作。
- `meta-curl-api/core/clients/`: 负责与最下游的外部API（如Meta Graph API）进行直接通信。

#### **配置中心化 (Centralized Configuration)**
- 所有配置，如API密钥、访问令牌、服务器地址等，都应在`core/config.py`中通过Pydantic模型进行管理，并通过环境变量加载。

#### **数据模型驱动 (Model-Driven with Pydantic)**
- 所有API的输入输出、服务层之间的数据传递，都必须使用Pydantic模型进行定义。这能确保数据的一致性、有效性，并自动生成OpenAPI文档。

## 3. 开发工作流与最佳实践

1.  **环境管理**: **必须**使用项目根目录的 `./service-manager.sh` 脚本来管理所有服务的生命周期（启动、停止、重启、查看状态）。这能确保开发环境的一致性。

2.  **需求分析 (定义工具)**: 从AI Agent的需求出发，定义需要提供的工具。明确每个工具的输入（参数）和输出（返回）。

3.  **创建服务 (Service First)**: 在`services/`目录下创建新的服务文件，实现核心业务逻辑。此时可以依赖模拟数据或一个简单的客户端。

4.  **创建路由 (Router Last)**: 在`routers/`目录下创建路由文件，使用FastAPI的`APIRouter`，将HTTP请求映射到已经实现的服务上。

5.  **测试驱动开发 (Test-Validated Development)**:
    - **单元测试**: 为`services/`中的核心业务逻辑编写单元测试。
    - **接口测试**: **严禁在未测试的情况下声称功能完成**。最低要求是使用`curl`命令对每一个新开发的API端点进行测试，验证其请求和响应是否符合预期。
    - **端到端测试**: 对于复杂流程，应编写脚本（如`scripts/`目录下的示例）模拟AI Agent的调用流程，进行端到端测试。

6.  **真实数据优先 (Real Data First)**: 开发和测试应始终优先使用真实的API和数据，而不是模拟数据(Mocks)。这能尽早发现集成问题。

## 4. 关键技术栈与组件

- **Web框架**: FastAPI。利用其高性能、异步支持和自动OpenAPI文档生成的特性。
- **数据验证**: Pydantic。用于所有数据模型的定义。
- **HTTP客户端**: `httpx`。支持异步请求，是与外部API通信的首选。
- **工具消费协议**: `streamable_http`。通过`mcp-client`库与AI Agent进行集成，实现工具的动态加载和流式响应。

## 5. 常见陷阱与解决方案

- **问题**: AI Agent无法调用工具，报告参数错误或缺失。
    - **原因**: 很可能是工具的函数签名（Docstring或类型提示）与实际实现不符，或者存在"可选但实际必需"的参数。
    - **解决方案**: 仔细审查工具的函数签名，确保所有必需参数都被正确标记。在Docstring中清晰地解释每个参数的用途和格式。

- **问题**: 功能在本地测试正常，但在集成环境中失败。
    - **原因**: 很可能是环境配置不一致导致，例如依赖的服务未启动、环境变量缺失。
    - **解决方案**: 严格使用`./service-manager.sh`管理环境。确保所有需要的环境变量都在`.env`文件中定义。

- **问题**: 声称API已完成，但前端或AI Agent集成时发现404或500错误。
    - **原因**: 未进行充分的接口测试。
    - **解决方案**: 将`curl`测试作为开发流程的强制环节。对于每个API端点，都必须提供一个可工作的`curl`示例命令。

## 6. 文档规范

- **版本与日期**: 所有设计文档、指南都必须在文档开头显著位置标明**版本号**和**最后更新日期**。
- **README**: 每个服务或重要模块都应有自己的`README.md`，解释其用途、如何配置和使用。 