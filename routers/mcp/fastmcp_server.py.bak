#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
åŸºäºå®˜æ–¹FastMCPçš„Images API MCPæœåŠ¡å™¨å®ç°

ä½¿ç”¨å®˜æ–¹æ¨èçš„FastMCPåº“ï¼Œæ”¯æŒstreamable HTTPåè®®
"""

import asyncio
from typing import Dict, List, Optional, Any, Union
from fastmcp import FastMCP

from core.config import settings
from core.logger import get_mcp_logger
from .images_tools import (
    create_gpt_image_tool,
    create_gpt_image_edit_tool,
    create_recraft_image_tool,
    create_seedream_image_tool,
    create_seededit_image_tool,
    create_flux_image_tool,
    create_stable_diffusion_image_tool,
    create_hailuo_image_tool,
    create_doubao_image_tool,
    upload_image_file_tool,
    create_veo3_video_tool,
    get_veo3_task_tool,
    create_veo3_official_video_tool,
    check_veo3_official_status_tool
)

logger = get_mcp_logger()

# =============================================================================
# åˆ›å»ºFastMCPåº”ç”¨
# =============================================================================

# åˆ›å»ºFastMCPåº”ç”¨å®ä¾‹ - ä½¿ç”¨æ— çŠ¶æ€HTTPæ¨¡å¼è§£å†³sessioné—®é¢˜
mcp_app = FastMCP(name="Images API MCP Service", stateless_http=True)

# =============================================================================
# å›¾åƒç”Ÿæˆå·¥å…·æ³¨å†Œ
# =============================================================================

@mcp_app.tool()
def create_gpt_image(
    prompt: str,
    model: str = "gpt-image-1", 
    n: int = 1,
    response_format: str = "url",
    size: str = "auto",
    background: str = "auto",
    quality: str = "auto",
    moderation: str = "auto"
) -> str:
    """
    åˆ›å»ºGPTå›¾åƒç”Ÿæˆä»»åŠ¡ - ä½¿ç”¨gpt-image-1æ¨¡å‹æ ¹æ®æ–‡æœ¬æè¿°ç”Ÿæˆå›¾åƒ
    
    Args:
        prompt: å›¾åƒæè¿°æç¤ºè¯ï¼Œè¯¦ç»†æè¿°æƒ³è¦ç”Ÿæˆçš„å›¾åƒå†…å®¹
        model: æ¨¡å‹åç§°ï¼Œé»˜è®¤ gpt-image-1
        n: ç”Ÿæˆå›¾åƒæ•°é‡
        response_format: è¿”å›æ ¼å¼ (url, b64_json, oss_url)ï¼Œé»˜è®¤ url
        size: å›¾åƒå°ºå¯¸ (1024x1024, 1536x1024, 1024x1536, auto)ï¼Œé»˜è®¤ auto
        background: èƒŒæ™¯ç±»å‹ (transparent, opaque, auto)ï¼Œé»˜è®¤ auto
        quality: å›¾åƒè´¨é‡ (high, medium, low, auto)ï¼Œé»˜è®¤ auto
        moderation: å†…å®¹å®¡æ ¸çº§åˆ« (low, auto)ï¼Œé»˜è®¤ auto
    
    Returns:
        JSONæ ¼å¼çš„å›¾åƒç”Ÿæˆç»“æœ
    """
    return asyncio.run(create_gpt_image_tool(
        prompt=prompt, model=model, n=n, response_format=response_format,
        size=size, background=background, quality=quality, moderation=moderation
    ))

@mcp_app.tool()
def create_gpt_image_edit(
    image_description: str = "è¯·æè¿°æ‚¨è¦ç¼–è¾‘çš„å›¾ç‰‡",
    prompt: str = "è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ", 
    model: str = "gpt-image-1",
    n: int = 1,
    size: str = "1024x1024",
    response_format: str = "url"
) -> str:
    """
    GPTå›¾åƒç¼–è¾‘å·¥å…·ï¼ˆè™šæ‹Ÿæ¥å£ï¼‰- ç”±äºMCPåè®®ä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼Œæ­¤å·¥å…·æä¾›REST APIè°ƒç”¨æŒ‡å—
    
    Args:
        image_description: è¦ç¼–è¾‘çš„å›¾ç‰‡æè¿°ï¼ˆä»…ç”¨äºè¯´æ˜ï¼‰
        prompt: ç¼–è¾‘æ•ˆæœæè¿°
        model: æ¨¡å‹åç§°ï¼Œé»˜è®¤gpt-image-1
        n: ç”Ÿæˆå›¾ç‰‡æ•°é‡ï¼Œ1-10ä¹‹é—´
        size: å›¾ç‰‡å°ºå¯¸ï¼Œ256x256/512x512/1024x1024
        response_format: è¿”å›æ ¼å¼ï¼Œurlæˆ–b64_json
    
    Returns:
        JSONæ ¼å¼çš„ä½¿ç”¨æŒ‡å—
    """
    return asyncio.run(create_gpt_image_edit_tool(
        image_description=image_description, prompt=prompt, model=model,
        n=n, size=size, response_format=response_format
    ))

@mcp_app.tool()
def create_recraft_image(
    prompt: str,
    style: str = "realistic",
    size: str = "1024x1024", 
    image_format: str = "png"
) -> str:
    """
    åˆ›å»ºRecraftå›¾åƒç”Ÿæˆä»»åŠ¡ - ä¸“ä¸šçš„å›¾åƒåˆ›ä½œå·¥å…·
    
    Args:
        prompt: å›¾åƒæè¿°æç¤ºè¯
        style: å›¾åƒé£æ ¼
        size: å›¾åƒå°ºå¯¸
        image_format: å›¾åƒæ ¼å¼
    
    Returns:
        JSONæ ¼å¼çš„å›¾åƒç”Ÿæˆç»“æœ
    """
    return asyncio.run(create_recraft_image_tool(
        prompt=prompt, style=style, size=size, image_format=image_format
    ))

@mcp_app.tool()
def create_flux_image(
    prompt: str,
    aspect_ratio: str = "1:1",
    steps: int = 20,
    guidance: float = 7.5,
    seed: Optional[int] = None
) -> str:
    """
    åˆ›å»ºFLUXå›¾åƒç”Ÿæˆä»»åŠ¡ - é«˜è´¨é‡çš„å¼€æºå›¾åƒç”Ÿæˆæ¨¡å‹
    
    Args:
        prompt: å›¾åƒæè¿°æç¤ºè¯
        aspect_ratio: å®½é«˜æ¯”
        steps: æ¨ç†æ­¥æ•°
        guidance: å¼•å¯¼å¼ºåº¦
        seed: éšæœºç§å­ï¼ˆå¯é€‰ï¼‰
    
    Returns:
        JSONæ ¼å¼çš„å›¾åƒç”Ÿæˆç»“æœ
    """
    return asyncio.run(create_flux_image_tool(
        prompt=prompt, aspect_ratio=aspect_ratio, steps=steps,
        guidance=guidance, seed=seed
    ))

@mcp_app.tool()
def create_hailuo_image(
    prompt: str,
    size: str = "1024x1024",
    quality: str = "standard",
    seed: Optional[int] = None
) -> str:
    """
    åˆ›å»ºæµ·èºå›¾ç‰‡ç”Ÿæˆä»»åŠ¡ - æµ·èºAIçš„å›¾åƒç”Ÿæˆ
    
    Args:
        prompt: å›¾åƒæè¿°æç¤ºè¯
        size: å›¾åƒå°ºå¯¸
        quality: å›¾åƒè´¨é‡
        seed: éšæœºç§å­ï¼ˆå¯é€‰ï¼‰
    
    Returns:
        JSONæ ¼å¼çš„å›¾åƒç”Ÿæˆç»“æœ
    """
    return asyncio.run(create_hailuo_image_tool(
        prompt=prompt, size=size, quality=quality, seed=seed
    ))

@mcp_app.tool()
def create_doubao_image(
    prompt: str,
    size: str = "1024x1024",
    guidance_scale: int = 3,
    watermark: bool = True
) -> str:
    """
    åˆ›å»ºDoubaoå›¾ç‰‡ç”Ÿæˆä»»åŠ¡ - å­—èŠ‚è·³åŠ¨çš„å›¾åƒç”Ÿæˆ
    
    Args:
        prompt: å›¾åƒæè¿°æç¤ºè¯
        size: å›¾åƒå°ºå¯¸
        guidance_scale: æŒ‡å¯¼å¼ºåº¦
        watermark: æ˜¯å¦æ·»åŠ æ°´å°
    
    Returns:
        JSONæ ¼å¼çš„å›¾åƒç”Ÿæˆç»“æœ
    """
    return asyncio.run(create_doubao_image_tool(
        prompt=prompt, size=size, guidance_scale=guidance_scale, watermark=watermark
    ))

# =============================================================================
# è§†é¢‘ç”Ÿæˆå·¥å…·æ³¨å†Œ
# =============================================================================

@mcp_app.tool()
async def create_veo3_video(
    prompt: str,
    model: str = "veo3",
    images: Optional[List[str]] = None,
    enhance_prompt: bool = True
) -> str:
    """
    åˆ›å»ºVeo3è§†é¢‘ç”Ÿæˆä»»åŠ¡ - Google Veo3æ¨¡å‹çš„è§†é¢‘ç”ŸæˆåŠŸèƒ½
    
    Args:
        prompt: è§†é¢‘æè¿°æç¤ºè¯ï¼Œè¯¦ç»†æè¿°æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹
        model: æ¨¡å‹åç§° (veo3, veo3-frames, veo3-pro, veo3-pro-frames)
        images: å›¾åƒURLåˆ—è¡¨ï¼ˆå›¾ç”Ÿè§†é¢‘éœ€è¦ï¼Œæ–‡ç”Ÿè§†é¢‘ä¼šå¿½ç•¥ï¼‰
        enhance_prompt: æ˜¯å¦å¢å¼ºæç¤ºè¯
    
    Returns:
        JSONæ ¼å¼çš„è§†é¢‘ç”Ÿæˆç»“æœ
    """
    return await create_veo3_video_tool(
        prompt=prompt, model=model, images=images, enhance_prompt=enhance_prompt
    )

@mcp_app.tool()
async def get_veo3_task(task_id: str) -> str:
    """
    è·å–Veo3è§†é¢‘ç”Ÿæˆä»»åŠ¡çŠ¶æ€ - æŸ¥è¯¢ä»»åŠ¡è¿›åº¦å’Œè·å–è§†é¢‘ç»“æœ
    
    Args:
        task_id: ä»»åŠ¡IDï¼Œä»åˆ›å»ºä»»åŠ¡æ—¶è¿”å›çš„å“åº”ä¸­è·å–
    
    Returns:
        JSONæ ¼å¼çš„ä»»åŠ¡çŠ¶æ€ä¿¡æ¯
    """
    return await get_veo3_task_tool(task_id=task_id)


@mcp_app.tool()
async def create_veo3_official_video(
    prompt: str,
    duration: int = 5,
    aspect_ratio: str = "16:9",
    seed: Optional[int] = None,
    guidance_scale: Optional[float] = None,
    negative_prompt: Optional[str] = None
) -> str:
    """
    åˆ›å»ºGoogle Vertex AIå®˜æ–¹Veo3è§†é¢‘ç”Ÿæˆä»»åŠ¡ï¼ˆçº¯å¼‚æ­¥æ¨¡å¼ï¼‰
    
    Args:
        prompt: è§†é¢‘æè¿°æç¤ºè¯ï¼Œè¯¦ç»†æè¿°æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹
        duration: è§†é¢‘æ—¶é•¿(ç§’)ï¼ŒèŒƒå›´1-30ï¼Œé»˜è®¤5ç§’
        aspect_ratio: å®½é«˜æ¯”ï¼Œæ”¯æŒ16:9, 9:16, 1:1, 4:3, 3:4ï¼Œé»˜è®¤16:9
        seed: éšæœºç§å­ï¼Œç”¨äºå¤ç°ç»“æœ
        guidance_scale: å¼•å¯¼ç¼©æ”¾å€¼ï¼Œæ§åˆ¶ç”Ÿæˆä¸æç¤ºè¯çš„åŒ¹é…ç¨‹åº¦
        negative_prompt: è´Ÿé¢æç¤ºè¯ï¼Œæè¿°ä¸æƒ³è¦çš„å†…å®¹
    
    Returns:
        JSONæ ¼å¼çš„è§†é¢‘ç”Ÿæˆç»“æœï¼ŒåŒ…å«operation_idç”¨äºåç»­çŠ¶æ€æŸ¥è¯¢
    """
    return await create_veo3_official_video_tool(
        prompt=prompt, duration=duration, aspect_ratio=aspect_ratio,
        wait_for_completion=False, max_wait=600,  # å¼ºåˆ¶å¼‚æ­¥æ¨¡å¼
        seed=seed, guidance_scale=guidance_scale, negative_prompt=negative_prompt
    )

@mcp_app.tool()
async def check_veo3_official_status(operation_id: str) -> str:
    """
    æ£€æŸ¥Google Vertex AIå®˜æ–¹Veo3ä»»åŠ¡çŠ¶æ€
    
    Args:
        operation_id: ä»»åŠ¡æ“ä½œIDï¼Œä»åˆ›å»ºä»»åŠ¡æ—¶è¿”å›
    
    Returns:
        JSONæ ¼å¼çš„ä»»åŠ¡çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…å«çŠ¶æ€ã€æ•°æ®ç­‰
    """
    return await check_veo3_official_status_tool(operation_id=operation_id)

# =============================================================================
# è¾…åŠ©å·¥å…·æ³¨å†Œ
# =============================================================================

@mcp_app.tool()
def upload_image_file(
    file_description: str,
    folder: str = "uploads"
) -> str:
    """
    ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶å·¥å…· - æä¾›å›¾ç‰‡ä¸Šä¼ APIçš„ä½¿ç”¨æŒ‡å¯¼
    
    Args:
        file_description: å›¾ç‰‡æ–‡ä»¶æè¿°ï¼ˆç”¨äºæç¤ºï¼‰
        folder: å­˜å‚¨æ–‡ä»¶å¤¹åç§°
    
    Returns:
        JSONæ ¼å¼çš„ä¸Šä¼ æŒ‡å¯¼ä¿¡æ¯
    """
    return asyncio.run(upload_image_file_tool(
        file_description=file_description, folder=folder
    ))

# =============================================================================
# èµ„æºå’Œæç¤ºæ³¨å†Œ
# =============================================================================

@mcp_app.resource("images://config")
def get_config():
    """Images APIé…ç½®ä¿¡æ¯"""
    return {
        "name": "Images API",
        "version": "1.0.0",
        "description": "å¤šç§å›¾åƒç”ŸæˆAI APIä»£ç†æœåŠ¡çš„MCPå·¥å…·é›†åˆ",
        "modules": [
            "gpt_image", "recraft_image", "flux_image", 
            "hailuo_image", "doubao_image", "veo3_video"
        ],
        "supported_models": [
            "GPT (DALL-E 2/3)", "Recraft", "FLUX", 
            "æµ·èºAI", "è±†åŒ…", "Veo3è§†é¢‘"
        ],
        "api_key_managed": True,
        "python_version": "3.11+",
        "features": [
            "æ–‡ç”Ÿå›¾", "å›¾åƒç¼–è¾‘", "è§†é¢‘ç”Ÿæˆ", "å¤šæ¨¡å‹æ”¯æŒ"
        ]
    }

@mcp_app.prompt("images_usage_guide")
def images_usage_guide():
    """Images APIä½¿ç”¨æŒ‡å—"""
    return """
# Images API ä½¿ç”¨æŒ‡å—

## åŠŸèƒ½æ¦‚è§ˆ
Images APIæä¾›å¤šç§AIå›¾åƒå’Œè§†é¢‘ç”ŸæˆåŠŸèƒ½ï¼š

### 1. GPTå›¾åƒç”Ÿæˆ (DALL-E)
ä½¿ç”¨OpenAI DALL-Eæ¨¡å‹ç”Ÿæˆé«˜è´¨é‡å›¾åƒ
- **å·¥å…·**: create_gpt_image
- **å‚æ•°**: promptï¼ˆå¿…éœ€ï¼‰, model, n, size, quality, style
- **æ¨¡å‹**: dall-e-3ï¼ˆæ¨èï¼‰, dall-e-2
- **å°ºå¯¸**: 1024x1024, 1792x1024, 1024x1792ç­‰

### 2. Recraftå›¾åƒç”Ÿæˆ
ä¸“ä¸šçš„å›¾åƒåˆ›ä½œå·¥å…·ï¼Œæ”¯æŒå¤šç§è‰ºæœ¯é£æ ¼
- **å·¥å…·**: create_recraft_image
- **å‚æ•°**: promptï¼ˆå¿…éœ€ï¼‰, style, size, image_format
- **é£æ ¼**: realistic, artistic, vectorç­‰
- **æ ¼å¼**: png, jpg

### 3. FLUXå›¾åƒç”Ÿæˆ
é«˜è´¨é‡çš„å¼€æºå›¾åƒç”Ÿæˆæ¨¡å‹
- **å·¥å…·**: create_flux_image
- **å‚æ•°**: promptï¼ˆå¿…éœ€ï¼‰, aspect_ratio, steps, guidance, seed
- **æ¨ç†æ­¥æ•°**: 1-50ï¼Œæ¨è20
- **å¼•å¯¼å¼ºåº¦**: 1.0-20.0ï¼Œæ¨è7.5

### 4. æµ·èºAIå›¾åƒç”Ÿæˆ
æµ·èºAIçš„å›¾åƒç”ŸæˆæœåŠ¡
- **å·¥å…·**: create_hailuo_image
- **å‚æ•°**: promptï¼ˆå¿…éœ€ï¼‰, size, quality, seed

### 5. è±†åŒ…å›¾åƒç”Ÿæˆ
å­—èŠ‚è·³åŠ¨çš„å›¾åƒç”ŸæˆæœåŠ¡
- **å·¥å…·**: create_doubao_image
- **å‚æ•°**: promptï¼ˆå¿…éœ€ï¼‰, size, guidance_scale, watermark
- **æŒ‡å¯¼å¼ºåº¦**: 1-10ï¼Œæ¨è3

### 6. Veo3è§†é¢‘ç”Ÿæˆ
Google Veo3æ¨¡å‹çš„è§†é¢‘ç”ŸæˆåŠŸèƒ½
- **å·¥å…·**: create_veo3_video, get_veo3_task
- **æ”¯æŒ**: æ–‡ç”Ÿè§†é¢‘ã€å›¾ç”Ÿè§†é¢‘
- **æ¨¡å‹**: veo3, veo3-frames, veo3-proç­‰

### 7. Veo3å®˜æ–¹è§†é¢‘ç”Ÿæˆ
Google Vertex AIå®˜æ–¹Veo3æœåŠ¡
- **å·¥å…·**: create_veo3_official_video, check_veo3_official_status
- **æ”¯æŒ**: é«˜è´¨é‡è§†é¢‘ç”Ÿæˆï¼Œå®˜æ–¹API

## é‡è¦æç¤º
- âœ… APIå¯†é’¥å·²åœ¨æœåŠ¡ç«¯é…ç½®ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’
- ğŸ¯ æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šè¿”å›JSONæ ¼å¼ç»“æœ
- ğŸ“Š åŒ…å«å›¾åƒ/è§†é¢‘URLã€ä»»åŠ¡ä¿¡æ¯ç­‰å®Œæ•´æ•°æ®
- ğŸ”„ æ”¯æŒå¼‚æ­¥è°ƒç”¨å’ŒçŠ¶æ€æŸ¥è¯¢
- ğŸ“ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå¼‚å¸¸å¤„ç†

## æœ€ä½³å®è·µ
1. **æç¤ºè¯ä¼˜åŒ–**: è¯¦ç»†æè¿°æƒ³è¦çš„ç»“æœï¼ŒåŒ…å«é£æ ¼ã€æƒ…æ„Ÿã€ç¯å¢ƒ
2. **å‚æ•°è°ƒä¼˜**: æ ¹æ®éœ€æ±‚è°ƒæ•´å„ç§æ§åˆ¶å‚æ•°
3. **æ¨¡å‹é€‰æ‹©**: æ ¹æ®ç”¨é€”é€‰æ‹©æœ€é€‚åˆçš„ç”Ÿæˆæ¨¡å‹
4. **é”™è¯¯å¤„ç†**: æ£€æŸ¥è¿”å›ç»“æœä¸­çš„é”™è¯¯ä¿¡æ¯

## æŠ€æœ¯æ¶æ„
- ğŸ—ï¸ åŸºäºFastMCPçš„å®˜æ–¹MCPå®ç°
- ğŸ”§ æ ‡å‡†MCPåè®®å…¼å®¹ï¼Œæ”¯æŒAI Agentè°ƒç”¨
- ğŸš€ å¼‚æ­¥å¤„ç†ï¼Œé«˜æ€§èƒ½å¹¶å‘
- ğŸ›¡ï¸ å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- ğŸ“¦ ç»Ÿä¸€çš„å“åº”æ ¼å¼å’ŒçŠ¶æ€ç®¡ç†
"""

# =============================================================================
# æœåŠ¡å¯åŠ¨å‡½æ•°
# =============================================================================

def run_mcp_server():
    """è¿è¡ŒMCPæœåŠ¡å™¨"""
    logger.info("âœ… FastMCP Images APIæœåŠ¡åˆå§‹åŒ–å®Œæˆ")
    logger.info(f"   ğŸŒ æœåŠ¡åœ°å€: {settings.mcp.host}:{settings.mcp.port}")
    logger.info(f"   ğŸ”— åè®®: http (FastMCPå…¼å®¹æ¨¡å¼)")
    
    # è¿è¡ŒMCPæœåŠ¡å™¨ - FastMCPä¼šå†…éƒ¨ç®¡ç†asyncio
    mcp_app.run(
        transport="http",
        host=settings.mcp.host,
        port=settings.mcp.port
    )

if __name__ == "__main__":
    asyncio.run(run_mcp_server())