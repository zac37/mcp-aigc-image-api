# Dockeréƒ¨ç½²ç»éªŒæ€»ç»“

## éƒ¨ç½²æ¦‚è¿°

æœ¬æ¬¡æˆåŠŸå°†Images APIæœåŠ¡éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨çš„Dockerç¯å¢ƒä¸­ï¼ŒåŒ…å«FastAPIæœåŠ¡(ç«¯å£5512)ã€MCPæœåŠ¡(ç«¯å£5513)å’ŒCelery Workerã€‚

## éƒ¨ç½²ç¯å¢ƒ

- **è¿œç¨‹æœåŠ¡å™¨**: 8.219.206.213
- **ç”¨æˆ·**: ecs-user
- **æ¶æ„**: x86_64 (è¿œç¨‹) vs arm64 (æœ¬åœ°)
- **Dockerç‰ˆæœ¬**: 28.3.2
- **å¤–éƒ¨ä¾èµ–**: jarvis_redis, jarvis_minio (é€šè¿‡jarvis-v2_defaultç½‘ç»œ)

## éƒ¨ç½²è„šæœ¬é€‰æ‹©

### 1. `deploy-remote-production.sh` - ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼ âœ…
- ç›´æ¥åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ„å»ºé•œåƒ
- é€‚åˆç½‘ç»œè‰¯å¥½ã€è¿œç¨‹æœåŠ¡å™¨æ€§èƒ½è¶³å¤Ÿçš„æƒ…å†µ
- **æ¨èä½¿ç”¨**ï¼Œéƒ¨ç½²è¿‡ç¨‹æ›´ç¨³å®š

### 2. `build-and-deploy.sh` - è·¨å¹³å°æ„å»ºéƒ¨ç½²
- æœ¬åœ°æ„å»ºarm64â†’amd64è·¨å¹³å°é•œåƒ
- ä¼ è¾“é•œåƒæ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨
- é€‚åˆæœ¬åœ°å’Œè¿œç¨‹æ¶æ„ä¸åŒä¸”è¿œç¨‹æ„å»ºå›°éš¾çš„æƒ…å†µ

## é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### 1. å…¨å±€å˜é‡æœªå®šä¹‰é”™è¯¯
**é—®é¢˜**: `_veo3_client`å˜é‡åœ¨cleanupå‡½æ•°ä¸­è¢«å¼•ç”¨ä½†æœªå®šä¹‰
```bash
NameError: name '_veo3_client' is not defined
```

**è§£å†³æ–¹æ¡ˆ**: åœ¨`core/images_client.py`ä¸­æ·»åŠ å…¨å±€å˜é‡å®šä¹‰
```python
# å…¨å±€å®¢æˆ·ç«¯å®ä¾‹
_images_client: Optional[ImagesAPIClient] = None
_veo3_client: Optional[Any] = None  # æ·»åŠ è¿™è¡Œ
_vertex_veo_client: Optional[VertexAIVeoClient] = None
```

### 2. Dockerå¯åŠ¨è„šæœ¬PIDå¤„ç†é”™è¯¯
**é—®é¢˜**: `start_service()`å‡½æ•°é”™è¯¯åœ°è¿”å›PIDå€¼ï¼Œå¯¼è‡´åç»­æ£€æŸ¥å¤±è´¥
```bash
return $pid  # é”™è¯¯ï¼šbashå‡½æ•°è¿”å›å€¼åº”è¯¥æ˜¯0-255çš„çŠ¶æ€ç 
```

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹`docker-entrypoint.sh`ï¼Œå°†PIDå†™å…¥ä¸´æ—¶æ–‡ä»¶
```bash
# ä¿®æ”¹å‰
return $pid

# ä¿®æ”¹å
echo $pid > "/tmp/${service_name}.pid"
return 0

# è·å–PIDçš„æ–¹å¼ä¹Ÿç›¸åº”ä¿®æ”¹
FASTAPI_PID=$(cat /tmp/fastapi.pid)
```

### 3. æ—¥å¿—æ–‡ä»¶æƒé™é—®é¢˜
**é—®é¢˜**: å®¹å™¨ä¸­appuseræ— æ³•åˆ›å»º/å†™å…¥æ—¥å¿—æ–‡ä»¶
```bash
PermissionError: [Errno 13] Permission denied: '/app/logs/access.log'
```

**è§£å†³æ–¹æ¡ˆç»„åˆ**:
1. **Dockerfileæƒé™ä¿®å¤**:
```dockerfile
RUN mkdir -p /app/logs /app/tmp && \
    chown -R appuser:appuser /app && \
    chmod -R 755 /app && \
    chmod -R 777 /app/logs  # æ·»åŠ æ—¥å¿—ç›®å½•å†™æƒé™
```

2. **ä¸´æ—¶ç¦ç”¨è®¿é—®æ—¥å¿—ä¸­é—´ä»¶**:
```python
# æ³¨é‡Šæ‰è®¿é—®æ—¥å¿—ä¸­é—´ä»¶é¿å…æƒé™é—®é¢˜
# @app.middleware("http")
# async def log_requests(request: Request, call_next):
```

3. **éƒ¨ç½²æ—¶æ¸…ç†æ—§æ—¥å¿—**:
```bash
sudo rm -rf logs/*  # æ¸…ç†æƒé™æ··ä¹±çš„æ—§æ—¥å¿—æ–‡ä»¶
```

## æˆåŠŸéƒ¨ç½²éªŒè¯

### æœåŠ¡çŠ¶æ€æ£€æŸ¥
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
sudo docker-compose -f docker-compose.production.yml ps

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://8.219.206.213:5512/api/health

# æ£€æŸ¥æ ¹è·¯å¾„
curl http://8.219.206.213:5512/

# æ£€æŸ¥MCPæœåŠ¡
curl http://8.219.206.213:5513/mcp/v1
```

### æœ€ç»ˆæœåŠ¡åœ°å€
- ğŸŒ **APIæ–‡æ¡£**: http://8.219.206.213:5512/docs
- ğŸ’— **å¥åº·æ£€æŸ¥**: http://8.219.206.213:5512/api/health  
- ğŸ”§ **MCPæœåŠ¡**: http://8.219.206.213:5513/mcp/v1
- ğŸ“‹ **æœåŠ¡ä¿¡æ¯**: http://8.219.206.213:5512/

## éƒ¨ç½²æœ€ä½³å®è·µ

### 1. é¢„éƒ¨ç½²æ£€æŸ¥
```bash
# æ‰§è¡ŒDockerå…¼å®¹æ€§æ£€æŸ¥
./check_docker_compatibility.sh

# æµ‹è¯•SSHè¿æ¥
ssh ecs-user@8.219.206.213 "echo 'SSHè¿æ¥æµ‹è¯•'"

# æ£€æŸ¥å¤–éƒ¨æœåŠ¡çŠ¶æ€
sudo docker ps | grep jarvis_redis
sudo docker ps | grep jarvis_minio
```

### 2. éƒ¨ç½²æµç¨‹
```bash
# ä½¿ç”¨æ¨èçš„éƒ¨ç½²è„šæœ¬
chmod +x deploy-remote-production.sh
./deploy-remote-production.sh
```

### 3. æ•…éšœæ’æŸ¥å‘½ä»¤
```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
ssh ecs-user@8.219.206.213 'cd /home/ecs-user/images-api && sudo docker-compose -f docker-compose.production.yml logs --tail=50'

# é‡å¯æœåŠ¡
ssh ecs-user@8.219.206.213 'cd /home/ecs-user/images-api && sudo docker-compose -f docker-compose.production.yml restart'

# è¿›å…¥å®¹å™¨è°ƒè¯•
ssh ecs-user@8.219.206.213 'sudo docker exec -it images-api-service bash'

# æ£€æŸ¥å®¹å™¨å†…æƒé™
sudo docker exec images-api-service ls -la /app/logs/
```

## å…³é”®é…ç½®æ–‡ä»¶

### docker-compose.production.yml
- ä½¿ç”¨å¤–éƒ¨Rediså’ŒMinIOæœåŠ¡
- è¿æ¥jarvis-v2_defaultç½‘ç»œ
- èµ„æºé™åˆ¶ï¼š2Gå†…å­˜ï¼Œ1.8æ ¸CPU
- å¥åº·æ£€æŸ¥é…ç½®

### Dockerfile
- åŸºäºPython 3.11-slim
- åˆ›å»ºappuserérootç”¨æˆ·
- æ­£ç¡®è®¾ç½®æ—¥å¿—ç›®å½•æƒé™
- å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–

### docker-entrypoint.sh
- å¥å£®çš„æœåŠ¡å¯åŠ¨è„šæœ¬
- å¤–éƒ¨æœåŠ¡ä¾èµ–æ£€æŸ¥
- è¿›ç¨‹ç›‘æ§å’Œè‡ªåŠ¨é‡å¯
- æ­£ç¡®çš„PIDç®¡ç†

## ç»éªŒæ•™è®­

1. **æƒé™é—®é¢˜é¢„é˜²**: åœ¨Dockerfileä¸­æ­£ç¡®è®¾ç½®ç›®å½•æƒé™ï¼Œé¿å…è¿è¡Œæ—¶æƒé™å†²çª
2. **æ—¥å¿—ç­–ç•¥**: ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Dockeræ—¥å¿—é©±åŠ¨è€Œéæ–‡ä»¶æ—¥å¿—ï¼Œé¿å…æƒé™é—®é¢˜
3. **ä¾èµ–æ£€æŸ¥**: éƒ¨ç½²å‰å……åˆ†æ£€æŸ¥å¤–éƒ¨æœåŠ¡ä¾èµ–ï¼Œç¡®ä¿ç½‘ç»œè¿é€šæ€§
4. **è„šæœ¬è°ƒè¯•**: bashè„šæœ¬ä¸­å‡½æ•°è¿”å›å€¼è¦æ­£ç¡®å¤„ç†ï¼Œé¿å…PIDç­‰å¤§æ•°å€¼è¿”å›
5. **åˆ†é˜¶æ®µéƒ¨ç½²**: å…ˆè§£å†³åŸºç¡€é—®é¢˜ï¼ˆæƒé™ã€ç½‘ç»œï¼‰ï¼Œå†å¤„ç†ä¸šåŠ¡é€»è¾‘
6. **å¿«é€Ÿä¿®å¤**: é‡åˆ°æƒé™ç­‰é˜»å¡æ€§é—®é¢˜æ—¶ï¼Œå¯ä»¥ä¸´æ—¶ç¦ç”¨ç›¸å…³åŠŸèƒ½å…ˆè®©æœåŠ¡è¿è¡Œ

## åç»­ä¼˜åŒ–å»ºè®®

1. **æ—¥å¿—ç³»ç»Ÿ**: é‡æ–°å¯ç”¨è®¿é—®æ—¥å¿—ï¼Œä½¿ç”¨Docker volumeæŒ‚è½½è§£å†³æƒé™é—®é¢˜
2. **ç›‘æ§å‘Šè­¦**: é›†æˆPrometheusç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ
3. **è‡ªåŠ¨åŒ–CI/CD**: åŸºäºæˆåŠŸçš„éƒ¨ç½²è„šæœ¬å»ºç«‹è‡ªåŠ¨åŒ–æµæ°´çº¿
4. **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶å’Œé‡è¦æ•°æ®
5. **å®‰å…¨åŠ å›º**: ä½¿ç”¨secretsç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œé™åˆ¶å®¹å™¨æƒé™

## æ”¯æŒçš„AIæ¨¡å‹

éƒ¨ç½²æˆåŠŸåæ”¯æŒä»¥ä¸‹15+ç§AIå›¾åƒ/è§†é¢‘ç”Ÿæˆæ¨¡å‹ï¼š
- GPT (DALL-E 2/3)
- Recraft / Recraftv3  
- å³æ¢¦3.0 / å³æ¢¦å«å›¾
- FLUX / Flux-kontext
- Cogview / æ··å…ƒ / Kling
- Stable Diffusion / Kolors
- è™šæ‹Ÿæ¢è¡£ / æµ·èºå›¾ç‰‡ / Doubao
- Veo3è§†é¢‘ç”Ÿæˆ

æ€»ç»“ï¼šæœ¬æ¬¡éƒ¨ç½²è™½ç„¶é‡åˆ°äº†ä¸€äº›æŠ€æœ¯é—®é¢˜ï¼Œä½†é€šè¿‡ç³»ç»Ÿæ€§çš„é—®é¢˜å®šä½å’Œè§£å†³ï¼Œæœ€ç»ˆæˆåŠŸéƒ¨ç½²äº†ä¸€ä¸ªå®Œæ•´çš„å¤šæ¨¡å‹AIå›¾åƒç”ŸæˆæœåŠ¡ã€‚éƒ¨ç½²è¿‡ç¨‹ä¸­çš„ç»éªŒå’Œè§£å†³æ–¹æ¡ˆä¸ºåç»­ç±»ä¼¼é¡¹ç›®æä¾›äº†å®è´µå‚è€ƒã€‚